# Nginx Load Balancer Configuration
# Advanced: Health Checks and Failover
#
# This configuration includes health checks, failover strategies,
# and advanced options for production-ready load balancing.
#
# Features:
# - Passive health checks (fail_timeout, max_fails)
# - Backup servers
# - Connection limits
# - Keepalive connections for better performance

events {
    worker_connections 1024;
}

http {
    # Include MIME types
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # Logging with detailed format
    log_format detailed '$remote_addr - $remote_user [$time_local] '
                       '"$request" $status $body_bytes_sent '
                       '"$http_referer" "$http_user_agent" '
                       'upstream: $upstream_addr '
                       'upstream_response_time: $upstream_response_time '
                       'request_time: $request_time';
    
    access_log /var/log/nginx/load_balancer_access.log detailed;
    error_log /var/log/nginx/load_balancer_error.log;
    
    # Define upstream backend servers with health checks
    upstream backend_servers {
        # Backend Server 1
        server localhost:8081 
               max_fails=3           # Consider server down after 3 failed attempts
               fail_timeout=30s;     # Wait 30s before retrying failed server
        
        # Backend Server 2
        server localhost:8082 
               max_fails=3
               fail_timeout=30s;
        
        # Backup server (only used if primary servers are down)
        # Uncomment if you have a backup server
        # server localhost:8083 backup;
        
        # Advanced options (uncomment to use):
        
        # Limit maximum connections to a server
        # server localhost:8081 max_conns=100;
        
        # Mark server as down temporarily (maintenance)
        # server localhost:8081 down;
        
        # Slow start (gradually increase traffic to server)
        # Useful when a server comes back online
        # server localhost:8081 slow_start=30s;
        
        # Keepalive connections for better performance
        keepalive 32;
    }
    
    # Load Balancer Server
    server {
        listen 80;
        server_name localhost;
        
        # Main location - proxy to backend servers
        location / {
            # Pass requests to the upstream backend servers
            proxy_pass http://backend_servers;
            
            # Preserve original client information
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Connection settings with timeouts
            proxy_connect_timeout 5s;     # Time to establish connection
            proxy_send_timeout 60s;       # Time to send request
            proxy_read_timeout 60s;       # Time to read response
            
            # Retry logic
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
            proxy_next_upstream_tries 2;  # Try up to 2 backend servers
            proxy_next_upstream_timeout 10s;
            
            # HTTP version and connection reuse
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # Buffering settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
            
            # Add headers to identify load balancer behavior
            add_header X-Load-Balancer-Algorithm "Round-Robin-With-Health-Checks" always;
            add_header X-Upstream-Server $upstream_addr always;
            add_header X-Response-Time $upstream_response_time always;
        }
        
        # Health check endpoint for the load balancer
        location /lb-health {
            access_log off;
            return 200 "Load Balancer is healthy (With Health Checks)\n";
            add_header Content-Type text/plain;
        }
        
        # Status page showing backend health
        location /lb-status {
            access_log off;
            return 200 "Backend Servers:\n- Server 1 (8081): Check /health\n- Server 2 (8082): Check /health\n";
            add_header Content-Type text/plain;
        }
    }
}
